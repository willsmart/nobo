#!/bin/bash

DIR=`realpath "$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/../.."`

secretsDir="secrets"
secretsFile="secrets.dat"

if [[ -f "$DIR/$secretsFile" ]]; then

  if [[ "$TH_SECRETS_PASSWORD_FILEPATH" == "" ]]; then
    echo "please set TH_SECRETS_PASSWORD_FILEPATH to point to a file with a password in it"
    exit 1
  fi 
  if [[ ! -f "$TH_SECRETS_PASSWORD_FILEPATH" ]]; then
    echo "TH_SECRETS_PASSWORD_FILEPATH doesn't point to a file, or I don't have permission to find it"
    exit 1
  fi 
  passPath=`realpath "$TH_SECRETS_PASSWORD_FILEPATH"`

  if [[ "$TH_DEEP_SECRETS_PASSWORD_FILEPATH" != "" && -f "$TH_DEEP_SECRETS_PASSWORD_FILEPATH" ]]; then
    deepPassPath=`realpath "$TH_DEEP_SECRETS_PASSWORD_FILEPATH"`
  fi

  cd "$DIR"
  
  echo "decrypting secrets"

  rm -rf "$secretsDir"
  openssl enc -aes-256-cbc -pass file:"$passPath" -d -in $secretsFile | tar xz -C "."

  if [[ -f $secretsDir/$secretsFile ]]; then
    if [[ "$deepPassPath" == "" ]]; then
      echo "please set TH_DEEP_SECRETS_PASSWORD_FILEPATH to point to a file with a password in it"
      exit 1
    fi 
    cd "$secretsDir"

    echo "decrypting deep secrets"
    openssl enc -aes-256-cbc -pass file:"$deepPassPath" -d -in $secretsFile | tar xz -C "."

    cd ..
  fi
fi
