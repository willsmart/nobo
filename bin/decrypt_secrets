#!/bin/bash

DIR=`realpath "$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/../.."`

secretsDir="secrets"
secretsFile="secrets.dat"
secretsSh="secrets.sh"

if [[ -f "$DIR/$secretsSh" ]]; then
  . "$DIR/secrets.sh"
fi

if [[ -f "$DIR/$secretsFile" ]]; then

  if [[ "$TH_SECRETS_PASSWORD" == "" ]]; then
    echo "please set TH_SECRETS_PASSWORD to the password for $secretsFile"
    exit 1
  fi 

  cd "$DIR"
  
  echo "decrypting secrets"

  rm -rf "$secretsDir"
  openssl enc -aes-256-cbc -pass pass:"$TH_SECRETS_PASSWORD" -d -in "$secretsFile" | tar xz -C "."

  if [[ -f "$secretsDir/$secretsFile" ]]; then
    if [[ "$TH_DEEP_SECRETS_PASSWORD" == "" ]]; then
      echo "please set TH_DEEP_SECRETS_PASSWORD to the password for $secretsDir/$secretsFile"
      exit 1
    fi 
    cd "$secretsDir"

    echo "decrypting deep secrets"
    openssl enc -aes-256-cbc -pass pass:"$TH_DEEP_SECRETS_PASSWORD" -d -in "$secretsFile" | tar xz -C "."

    cd ..
  fi
fi
