#!/bin/bash
args=$@
bindir=`realpath "$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"`
toolsdir="$bindir/../tools"

export pidfile="$bindir/../../joiner.pid"
function finish {
    res=$?
    if [[ -f "$pidfile" ]]; then
        kill `cat "$pidfile"`
        rm -f "$pidfile"
    fi
    echo "joiner out"
    exit $res
}
trap finish EXIT INT TERM

cd "$bindir/../.." # the App's base dir
ruby "$toolsdir/rb/joiner.rb" $args --loop &
child=$!
echo $child > "$pidfile"
wait $child