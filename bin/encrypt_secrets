#!/bin/bash

# this file encrypts secrets so they can be committed to git
# the first layer of secret is held in the "secrets" dir (which is automatically joined with the app, like the app specific dir "App")
# this dir should hold secrets that are available to anyone who holds the original dir structure that made the ModelServerImage, or holds the ModelServer root login
# the second layer of secret is in secrets/secrets, which is only available to those holding the original base password, not to be committed in any way
# (secrets dir is encrypted using a salted hash on the base password)

DIR=`realpath "$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/../.."`

secretsDir="secrets"
secretsFile="secrets.dat"

if [[ ! -d "$DIR/$secretsDir" ]]; then
  echo "No secrets dir to encrypt"
  exit 0
fi

if [[ "$TH_SECRETS_PASSWORD_FILEPATH" == "" ]]; then
  echo "please set TH_SECRETS_PASSWORD_FILEPATH to point to a file with a password in it"
  exit 1
fi 
if [[ ! -f "$TH_SECRETS_PASSWORD_FILEPATH" ]]; then
  echo "TH_SECRETS_PASSWORD_FILEPATH doesn't point to a file, or I don't have permission to find it"
  exit 1
fi 
passPath=`realpath "$TH_SECRETS_PASSWORD_FILEPATH"`

if [[ -d "$DIR/$secretsDir" ]]; then

  if [[ "$TH_DEEP_SECRETS_PASSWORD_FILEPATH" == "" ]]; then
    echo "please set TH_DEEP_SECRETS_PASSWORD_FILEPATH to point to a file with a password in it"
    exit 1
  fi 
  if [[ ! -f "$TH_DEEP_SECRETS_PASSWORD_FILEPATH" ]]; then
    echo "TH_DEEP_SECRETS_PASSWORD_FILEPATH doesn't point to a file, or I don't have permission to find it"
    exit 1
  fi 
  deepPassPath=`realpath "$TH_DEEP_SECRETS_PASSWORD_FILEPATH"`

  cd "$DIR/$secretsDir"
  echo "encrypting deep secrets"
  tar -cz -C "." "$secretsDir" | openssl enc -aes-256-cbc -pass file:"$deepPassPath" -out "$secretsFile"
  if [[ $? != 0 ]]; then
    echo "failed to encrypt deep secrets"
    exit 1
  fi
fi

cd "$DIR"
tar -cz -v --exclude='./$secretsDir/$secretsDir' -C "." "$secretsDir" | openssl enc -aes-256-cbc -pass file:"$passPath" -out "$secretsFile"
