#!/bin/bash
cd "$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/.."

LBLUE='\033[1;34m'
GREEN='\033[0;32m'
RED='\033[0;31m'
DARKGREY='\033[1;30m'
NC='\033[0m'

function section {
  echo -e "\n$LBLUE--- $1$DARKGREY"
}

function killRails {
  if [[ -f tmp/pids/server.pid ]]; then
    section "killing rails server"

    kill -INT `cat tmp/pids/server.pid`
    if [[ $? == 1 ]]; then
      break
    fi
    while [[ -f tmp/pids/server.pid ]]; do
      echo -n -e "$NC.$DARKGREY"
      sleep 1
    done
    echo -e "\n$NC"
  fi
}


killRails


section "Clearing old assets"
rm -rf public/assets/*

export RACK_ENV=production
export RAILS_ENV=production


section "Precompile production assets"
rake assets:precompile


section "Starting production rails server"
rails s -b 0.0.0.0 &
sleep 5
kill -0 `cat tmp/pids/server.pid`
if [[ $? == 1 ]]; then
  echo -e "\n$RED--- Couldn't start production rails server$NC"
  exit 1
fi


section "Requesting localhost:3000/page, this will be saved as index.html"
curl localhost:3000/page -o public/assets/index.html


killRails
mkdir -p tmp/production_assets
rm -rf tmp/production_assets/*


section "Copying assets and index.html into tmp/productionAssets"
cp {public/assets,tmp/production_assets}/index.html
cd public/assets
find . -mindepth 1 -exec cp {,../../tmp/production_assets/}{} \;
cd ../..


section "ls tmp/production_assets"
echo -e "$GREEN"
ls tmp/production_assets


echo -e "$NC\ndone making assets.\n"
